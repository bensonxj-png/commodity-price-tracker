name: æ¯æ—¥ä»·æ ¼æ›´æ–°

on:
  schedule:
    - cron: '0 1 * * *'  # æ¯å¤©åŒ—äº¬æ—¶é—´ä¸Šåˆ9:00 (UTC 1:00)
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write  # æ˜ç¡®æˆäºˆå†™å…¥æƒé™

jobs:
  update-prices:
    runs-on: ubuntu-latest

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: å®‰è£…ä¾èµ–
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt

    - name: è¿è¡Œçˆ¬è™«å¹¶ç”Ÿæˆæ•°æ®
      run: |
        python commodity_price_scraper.py

    - name: æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
      id: check_changes
      run: |
        git add å•†å“ä»·æ ¼æ•°æ®.xlsx
        if git diff --staged --quiet; then
          echo "has_changes=false" >> $GITHUB_OUTPUT
          echo "ğŸ“Š æ•°æ®æ— å˜åŒ–ï¼Œè·³è¿‡æäº¤"
        else
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "âœ… æ£€æµ‹åˆ°æ•°æ®æ›´æ–°"
        fi

    - name: æäº¤å¹¶æ¨é€æ›´æ–°
      if: steps.check_changes.outputs.has_changes == 'true'
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°ä»·æ ¼æ•°æ® $(date +'%Y-%m-%d %H:%M:%S')"
        git push

    - name: ä¸Šä¼ Excelæ–‡ä»¶ä¸ºå·¥ä»¶ï¼ˆå¤‡ä»½ï¼‰
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: price-data-${{ github.run_number }}
        path: å•†å“ä»·æ ¼æ•°æ®.xlsx
        retention-days: 30
